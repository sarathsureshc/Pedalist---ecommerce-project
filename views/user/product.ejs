<%- include('../partials/user/header.ejs') %>
<link rel="stylesheet" href="product-styles.css">

<div class="wrapper">
    <div class="sidebar">
        <h3><i class="bi bi-funnel"></i> Filters</h3>
        
        <!-- Search Section -->
        <div class="filter-section search-section">
            <label for="search" class="filter-label">
                <i class="bi bi-search"></i> Search Products
            </label>
            <div class="search-wrapper">
                <input id="search" placeholder="Search by name..." type="text" value="<%= search %>" class="input-field" aria-label="Search products"/>
                <button id="searchBtn" class="btn primary-btn"><i class="bi bi-search"></i> Search</button>
            </div>
        </div>
    
        <!-- Price Filter Section -->
        <div class="filter-section price-filter">
            <label class="filter-label">
                <i class="bi bi-currency-rupee"></i> Price Range
            </label>
            <div id="priceSlider" class="slider"></div>
            <div class="price-display">
                <span class="price-label">Selected:</span>
                <span class="price-value">₹<span id="selectedPriceRange">0 - 100,000</span></span>
            </div>
            <button id="applyPriceBtn" class="btn secondary-btn"><i class="bi bi-check-circle"></i> Apply Price</button>
        </div>
    
        <!-- Stock Filter Section -->
        <div class="filter-section out-of-stock-filter">
            <label class="checkbox-container">
                <input type="checkbox" id="showOutOfStock" <% if (showOutOfStock==="true") { %> checked <% } %>>
                <span class="checkbox-label">
                    <i class="bi bi-eye"></i> Show Out of Stock
                </span>
            </label>
        </div>
    
        <!-- Category Filter Section -->
        <div class="filter-section category-filter">
            <label for="category" class="filter-label">
                <i class="bi bi-grid"></i> Category
            </label>
            <select id="category" class="dropdown">
                <option value="">All Categories</option>
                <% categories.forEach(category => { %>
                    <option value="<%= category._id %>" <%= selectedCategory === category._id.toString() ? "selected" : "" %>>
                        <%= category.name %>
                    </option>
                <% }); %>
            </select>
        </div>
    
        <!-- Sort Options Section -->
        <div class="filter-section sorting-options">
            <label for="sortBy" class="filter-label">
                <i class="bi bi-sort-down"></i> Sort By
            </label>
            <select id="sortBy" class="dropdown">
                <option value="popularity" <%= sortBy === "popularity" ? "selected" : "" %>>Popularity</option>
                <option value="priceLowToHigh" <%= sortBy === "priceLowToHigh" ? "selected" : "" %>>Price: Low to High</option>
                <option value="priceHighToLow" <%= sortBy === "priceHighToLow" ? "selected" : "" %>>Price: High to Low</option>
                <option value="averageRating" <%= sortBy === "averageRating" ? "selected" : "" %>>Average Ratings</option>
                <option value="featured" <%= sortBy === "featured" ? "selected" : "" %>>Featured</option>
                <option value="newArrivals" <%= sortBy === "newArrivals" ? "selected" : "" %>>New Arrivals</option>
                <option value="aToZ" <%= sortBy === "aToZ" ? "selected" : "" %>>A - Z</option>
                <option value="zToA" <%= sortBy === "zToA" ? "selected" : "" %>>Z - A</option>
            </select>
        </div>
        
        <!-- Clear Filters Button -->
        <button id="clearFiltersBtn" class="btn clear-btn"><i class="bi bi-x-circle"></i> Clear All Filters</button>
    </div>    

    <div class="content-product">
        <div class="breadcrumbs">
            <a href="/">Home</a>
            <span>/</span>
            <a href="#">Products</a>
        </div>
        <h1>Products</h1>
        <p>Showing all <%= count %> results</p>
        <div class="products">
            <% products.forEach(product => { %>
                <a href="/product-detail?id=<%= product._id %>" class="product-card">
                    <div class="product">
                        <img alt="<%= product.productName %>" height="300" src="uploads/product-images/<%= product.image[0] %>" width="300" class="product-image"/>
                        <h3 class="product-title"><%= product.productName %></h3>
                        <h6 class="product-brand"><%= product.brand.brandName %></h6>
                        <p class="product-category"><%= product.category.name %></p>
                        <p class="product-price">
                            <% if (product.bestOffer) { %>
                                <span class="original-price">₹<%= product.price.toFixed(2) %></span>
                                <span class="discounted-price">₹<%= (product.price - product.bestOffer.effectiveDiscount).toFixed(2) %></span>
                                <p class="discount-info">You save: ₹<%= product.bestOffer.effectiveDiscount.toFixed(2) %></p>
                            <% } else { %>
                                <span class="discounted-price">₹<%= product.price.toFixed(2) %></span>
                            <% } %>
                        </p>
                        <p class="availability"> <%= product.quantity > 0 ? 'Available' : 'Out of Stock' %></p>
                    </div>
                </a>
            <% }); %>
        </div>
        <div class="pagination">
            <% if (currentPage > 1) { %>
                <a href="/products?page=<%= currentPage - 1 %>&sortBy=<%= sortBy %>&showOutOfStock=<%= showOutOfStock %>&category=<%= selectedCategory %>&minPrice=<%= minPrice %>&maxPrice=<%= maxPrice %>" class="pagination-link">Previous</a>
            <% } %>
            
            <% for (let i = 1; i <= totalPages; i++) { %>
                <a href="/products?page=<%= i %>&sortBy=<%= sortBy %>&showOutOfStock=<%= showOutOfStock %>&category=<%= selectedCategory %>&minPrice=<%= minPrice %>&maxPrice=<%= maxPrice %>" class="pagination-link <%= i === currentPage ? 'active' : '' %>"><%= i %></a>
            <% } %>
            
            <% if (currentPage < totalPages) { %>
                <a href="/products?page=<%= parseInt(currentPage) + 1 %>&sortBy=<%= sortBy %>&showOutOfStock=<%= showOutOfStock %>&category=<%= selectedCategory %>&minPrice=<%= minPrice %>&maxPrice=<%= maxPrice %>" class="pagination-link">Next</a>
            <% } %>
        </div>
    </div>
</div>

<%- include('../partials/user/footer.ejs') %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.6.3/nouislider.min.js"></script>
<script>
    // Initialize elements
    const priceSlider = document.getElementById('priceSlider');
    const selectedPriceRange = document.getElementById('selectedPriceRange');
    const searchInput = document.getElementById('search');
    const searchBtn = document.getElementById('searchBtn');
    const applyPriceBtn = document.getElementById('applyPriceBtn');
    const showOutOfStockCheckbox = document.getElementById('showOutOfStock');
    const categorySelect = document.getElementById('category');
    const sortBySelect = document.getElementById('sortBy');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');

    const minPrice = <%= minPrice %>;
    const maxPrice = <%= maxPrice %>;

    // Initialize price slider
    noUiSlider.create(priceSlider, {
        start: [minPrice, maxPrice],
        connect: true,
        range: {
            'min': 0,
            'max': 100000
        }
    });

    priceSlider.noUiSlider.on('update', function (values) {
        selectedPriceRange.innerHTML = Math.round(values[0]) + ' - ' + Math.round(values[1]);
    });

    priceSlider.noUiSlider.set([minPrice, maxPrice]);
    selectedPriceRange.innerHTML = minPrice + ' - ' + maxPrice; 

    // Apply filters function
    function applyFilters() {
        const searchQuery = searchInput.value;
        const sortBy = sortBySelect.value;
        const showOutOfStock = showOutOfStockCheckbox.checked;
        const category = categorySelect.value;

        const priceValues = priceSlider.noUiSlider.get();
        const minPrice = Math.round(priceValues[0]);
        const maxPrice = Math.round(priceValues[1]);

        const queryParams = new URLSearchParams();
        if (searchQuery) queryParams.append("search", searchQuery);
        if (sortBy) queryParams.append("sortBy", sortBy);
        if (showOutOfStock) {
            queryParams.append("showOutOfStock", "true");
        } else {
            queryParams.append("showOutOfStock", "false");
        }
        if (category) queryParams.append("category", category);

        queryParams.append("minPrice", minPrice);
        queryParams.append("maxPrice", maxPrice);

        window.location.href = `/products?${queryParams.toString()}`;
    }

    // Clear filters function
    function clearFilters() {
        window.location.href = '/products';
    }

    // Add event listeners
    searchBtn.addEventListener('click', applyFilters);
    applyPriceBtn.addEventListener('click', applyFilters);
    showOutOfStockCheckbox.addEventListener('change', applyFilters);
    categorySelect.addEventListener('change', applyFilters);
    sortBySelect.addEventListener('change', applyFilters);
    clearFiltersBtn.addEventListener('click', clearFilters);
    
    // Search on Enter key
    searchInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            applyFilters();
        }
    });
</script>