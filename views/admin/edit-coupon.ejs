<%- include('../partials/admin/header.ejs') %>
<div class="wrapper">
    <section class="coupon-main-content">
        <header class="dashboard-header">
            <h1>Edit Coupon</h1>
            <a href="/admin/logout" class="dashboard-logout-button btn btn-danger">Logout</a>
        </header>

        <form action="/admin/edit-coupon/<%= coupon._id %>" method="POST" onsubmit="return validateForm()">
            <div class="form-group">
                <label for="couponCode">Coupon Code:</label>
                <input type="text" id="couponCode" name="couponCode" value="<%= coupon.couponCode %>" required>
            </div>

            <div class="form-group">
                <label for="discountDescription">Coupon Description:</label>
                <input type="text" id="discountDescription" name="discountDescription" value="<%= coupon.discountDescription %>" required>
            </div>

            <div class="form-group">
                <label for="startDate">Start Date:</label>
                <input type="date" id="startDate" name="startDate" value="<%= coupon.startDate.toISOString().split('T')[0] %>" required>
            </div>

            <div class="form-group">
                <label for="endDate">End Date:</label>
                <input type="date" id="endDate" name="endDate" value="<%= coupon.endDate.toISOString().split('T')[0] %>" required>
            </div>

            <div class="form-group">
                <label for="minPurchaseAmount">Minimum Purchase Amount:</label>
                <input type="number" id="minPurchaseAmount" name="minPurchaseAmount" value="<%= coupon.minPurchaseAmount %>" step="0.01" required>
            </div>

            <div class="form-group">
                <label for="maxDiscountAmount">Maximum Discount Amount:</label>
                <input type="number" id="maxDiscountAmount" name="maxDiscountAmount" value="<%= coupon.maxDiscountAmount %>" step="0.01" required>
            </div>

            <div class="form-group">
                <label for="couponType">Coupon Type:</label>
                <select id="couponType" name="couponType" required>
                    <option value="Percentage" <%= coupon.couponType === 'Percentage' ? 'selected' : '' %>>Percentage</option>
                    <option value="Fixed" <%= coupon.couponType === 'Fixed' ? 'selected' : '' %>>Fixed</option>
                </select>
            </div>

            <div class="form-group">
                <label for="value">Discount Value:</label>
                <input type="number" id="value" name="value" value="<%= coupon.value %>" step="0.01" required>
            </div>

            <button type="submit" class="btn">Update Coupon</button>
        </form>

        <p><a href="/admin/coupons">Back to Coupons Management</a></p>
    </section>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

<script>
    function validateForm() {
        const couponCode = document.getElementById('couponCode').value;
        const discountDescription = document.getElementById('discountDescription').value;
        const minPurchaseAmount = parseFloat(document.getElementById('minPurchaseAmount').value);
        const maxDiscountAmount = parseFloat(document.getElementById('maxDiscountAmount').value);
        const startDate = new Date(document.getElementById('startDate').value);
        const endDate = new Date(document.getElementById('endDate').value);

        if (!validateCouponCode(couponCode)) {
            alert('Invalid coupon code: It must not contain spaces and can only include letters, numbers, and specific symbols (@, _, -).');
            return false;
        }

        if (!validateDiscountDescription(discountDescription)) {
            alert('Invalid description: It must contain alphabets or alphanumeric characters with symbols (@, _, -).');
            return false;
        }

        if (minPurchaseAmount <= maxDiscountAmount) {
            alert('Minimum purchase amount must be greater than the maximum discount amount.');
            return false;
        }

        if (endDate < startDate) {
            alert('End date must not be less than the start date.');
            return false;
        }

        return true;
    }

    function validateCouponCode(couponCode) {
        const regex = /^[\w@_.-]*$/; // allows letters, numbers, and specified symbols
        return regex.test(couponCode) && !/\s/.test(couponCode); // No spaces allowed
    }

    function validateDiscountDescription(description) {
        const regex = /^[A-Za-z0-9@_.-,"':;()&%/]*$/; // Modify as needed for your allowed characters
        return regex.test(description) && !/^\d+$/.test(description); // No all-numeric descriptions
    }
</script>

<%- include('../partials/admin/footer.ejs') %>
